# Übungen zu System Logging (108.2)

## rsyslog

>[!NOTE]
> Um die Übungen zum Syslog durchführen zu können, muss ab Debian 13 der Dienst `rsyslog` nachträglich installiert werden: `apt install rsyslog`.

### Übung 1: rsyslog Konfiguration
Schau dir die Hauptkonfigurationsdatei von rsyslog `/etc/rsyslog.conf` an. Diese ist unterteilt in die drei Abschnitte: Modules, Global Directives und Rules. Für uns sind insbesondere die Rules interessant.

- Was sind *Facilities*?
- Was sind *Priorities*?
- Was sind *Actions*?

### Übung 2: Bedeutung von Regeln
Erkläre die Bedeutung der folgenden `rsyslog`-Regeln:

- `mail.info`
- `kern.*`
- `*.crit`
- `auth,authpriv.notice`

### Übung 3: Benutzerdefinierte Log-Regel erstellen
Erstelle eine neue rsyslog-Regel, die alle Kernel-Meldungen mit Priorität `warning` und höher in die Datei `/var/log/kernel-warnings.log` schreibt.

### Übung 4: Logs an Remote-Server senden
Konfiguriere `rsyslog` so, dass alle Logs mit Priorität `err` und höher an einen Remote-Syslog-Server mit IP `192.168.1.100` auf Port 514 (UDP) gesendet werden.

### Übung 5: rsyslog als Log-Server konfigurieren
Konfiguriere rsyslog so, dass es als Log-Server fungiert und Logs von Remote-Hosts auf UDP Port 514 empfängt.

### Übung 6: Log-Rotation verstehen
Schau dir die logrotate-Konfiguration für rsyslog in `/etc/logrotate.d/rsyslog` an. Erkläre die wichtigsten Direktiven:

- `rotate 4`
- `weekly`
- `missingok`
- `notifempty`
- `compress`
- `delaycompress`
- `postrotate ... endscript`

---

## systemd Journal (journalctl)

### Übung 7: Journal-Einträge anzeigen

Verwende verschiedene `journalctl`-Optionen, um folgende Informationen anzuzeigen:

1. Alle Logs seit dem letzten Boot
2. Nur Kernel-Nachrichten
3. Logs der letzten Stunde
4. Logs mit Priorität `error` und höher

### Übung 8: Service-spezifische Logs
Zeige alle Logs des SSH-Dienstes (`sshd` oder `ssh.service`) an und folge neuen Einträgen in Echtzeit.

Beobachte so sowohl einen fehlerhaften als auch einen erfolgreichen Login Vorgang über eine andere Shell.

### Übung 9: Zeitbasierte Abfragen
1. Zeige alle Journal-Einträge von gestern an. 
2. Zeige alle Journal-Einträge von vor 2 Tagen an.
3. Zeige alle Journal-Einträge zwischen 09:00 und 10:00 Uhr an. 

### Übung 10: Journal-Ausgabeformate
Zeige die letzten 20 Journal-Einträge in verschiedenen Formaten an:

1. JSON-Format
2. JSON "Pretty"

### Übung 11: Journal-Speicherplatz verwalten
1. Prüfe, wie viel Speicherplatz das Journal aktuell verwendet.
2. Lösche alle Einträge aus dem Journal, die älter als 3 Tage sind.
3. Begrenze das Journal auf maximal 50 MB.

Wie könntest du die letzten beiden Einträge standardmässig konfigurieren? Was müsstest du also in die Datei `/etc/systemd/journald.conf` eingragen?

### Übung 12: Persistentes Journal aktivieren
Standardmäßig speichert `systemd-journald` Logs oft nur im RAM (`/run/log/journal`). Konfiguriere das Journal so, dass es persistent auf der Festplatte gespeichert wird. 

### Übung 13: Boot-Logs analysieren
1. Liste mit `journalctl` alle verfügbaren Boots auf 
2. Zeige die Logs des aktuellen Boots an.
3. Zeige die Logs des vorletzten Boots an.

### Übung 14: Journal-Einträge nach Prozess-ID filtern
1. Zeige alle Journal-Einträge an, die einen bestimmten User betreffen.
2. Zeige alle Journal-Einträge vom heutigen Tag an, die einen bestimmten User betreffen.

---

## logger Kommando

### Übung 16: Manuell Log-Nachrichten erstellen
Vor allem in Shell-Skripten können wir das Kommando `logger` verwenden, um Log-Meldungen zu erzeugen. Verwende das Kommando `logger`, um folgende Logeinträge zu erstellen (ohne dafür extra ein Skript zu schreiben):

1. Eine einfache Log-Meldung "Dies ist eine Log-Meldung"
2. Eine Log-Meldung mit der Facility `mail` und Priorität `warning` "Mail-Server Warnung: Hohe Last"
3. Eine Log-Meldung mit dem benutzerdefinierten Tag/Facility `myapp` "Anwendung gestartet"

### Übung 17: logger in Skripten verwenden
Erstelle ein einfaches Bash-Skript `~/bin/backup-script.sh`, das den gesamten Inhalt deines Heimatverzeichnisses nach `/tmp/backup-home` kopiert und:

1. Beim Start eine Info-Nachricht "Backup-Prozess gestartet" loggt
2. Bei erfolgreichem Durchlauf des Skripts eine Erfolgs-Nachricht "Backup erfolgreich" loggt
3. Bei einem Fehler die Fehler-Nachricht "Backup fehlgeschlagen" loggt

Prüfe Erfolg und Fehler dadurch, dass du das Backup einmal in `/tmp` erstellst (Erfolg) und einmal in `/` (Fehler).

---

## Log-Dateien analysieren

### Übung 18: Wichtige Log-Dateien kennen
Liste die wichtigsten Log-Dateien unter `/var/log/` auf und erkläre deren Zweck.

>[!NOTE]
> Diese Übung bezieht sich auf die Dateien, die unter Syslog erzeugt werden, der so unter deinem System nicht mehr genutzt wird. Daher sind hier einige wichtige Dateien gelistet:

Einige wichtige Log-Dateien:

- `/var/log/syslog`
- `/var/log/messages`
- `/var/log/auth.log`
- `/var/log/secure`
- `/var/log/kern.log`
- `/var/log/dmesg`
- `/var/log/boot.log`
- `/var/log/apache2/`
- `/var/log/mysql/`
- `/var/log/apt/`

### Übung 19: Fehlgeschlagene Login-Versuche finden
Finde alle fehlgeschlagenen SSH-Login-Versuche der letzten 24 Stunden mit zwei verschiedenen Methoden (klassische Logs und Journal). Erzeuge dazu ggf. welche in dem du die per SSH anmeldest, aber ein falsches Passwort eingibts.

### Übung 20: Kernel-Ring-Buffer analysieren
1. Zeige die aktuellen Kernel-Meldungen aus dem Kernel-Ring-Buffer mit `dmesg` an und filtere nach USB-Geräten. 
2. Kannst du dir auch Meldungen des vorherigen Bootvorgangs anzeigen lassen?

---

## logrotate

### Übung 21: logrotate-Konfiguration erstellen
Erstelle eine logrotate-Konfiguration für eine benutzerdefinierte Anwendung, deren Logs unter `/var/log/myapp/app.log` gespeichert werden. Die Logs sollen:

- Wöchentlich rotiert werden
- 4 alte Versionen behalten
- Komprimiert werden
- Rotiert werden, auch wenn sie leer sind

### Übung 22: logrotate mit postrotate-Script
Erweitere die Konfiguration aus der vorherigen Übung so, dass nach der Rotation ein Service neu geladen wird.

### Übung 23: logrotate Größen-basiert
Erstelle eine logrotate-Konfiguration, die rotiert, wenn die Log-Datei 100 MB erreicht und maximal 10 Rotationen behält.

---

## Erweiterte Übungen

### Übung 24: Log-Korrelation
Untersuche einen erfolgreichen SSH-Login:

1. Finde den Zeitpunkt des Logins in `/var/log/auth.log`
2. Zeige alle systemd-Journal-Einträge für diesen Zeitraum
3. Prüfe, ob Kernel-Meldungen zur gleichen Zeit auftraten

Wann bzw. wozu könnte eine solche Untersuchung sinnvoll sein? Was ist der Zweck?

### Übung 25: Log-Monitoring mit tail
Überwache gleichzeitig mehrere Log-Dateien in Echtzeit, also z.B. den `syslog` und `auth.log` einmal mit `tail -f` und mit `journalctl`. Logge dich dann einmal per SSH aus und wieder ein.


### Übung 26: Log-Archivierung
Exportiere alle Journal-Einträge der letzten Woche in eine Datei zur Archivierung.

## Liste mit für die Übungen relevanten Dateien, Verzeichnissen und Kommandos:

**Dateien und Verzeichnisse:**
- `/etc/rsyslog.conf`
- `/etc/rsyslog.d/`
- `/var/log/syslog` (Debian/Ubuntu)
- `/var/log/messages` (Red Hat/CentOS)
- `/var/log/auth.log`
- `/var/log/secure`
- `/var/log/kern.log`
- `/var/log/dmesg`
- `/var/log/boot.log`
- `/etc/logrotate.conf`
- `/etc/logrotate.d/`
- `/etc/systemd/journald.conf`
- `/var/log/journal/`
- `/run/log/journal/`

**Kommandos:**
- `rsyslogd`
- `journalctl`
- `systemd-journald`
- `logger`
- `logrotate`
- `dmesg`
- `tail`
- `systemctl`
